@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix fro: <https://ontology.firebim.be/ontology/fro#> .
@prefix fbo: <http://www.firebim.org/ontologies/FBO#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .

<https://ontology.firebim.be/ontology/fro#Article_2_2_1_1_Shape>
    a sh:NodeShape ;
    rdfs:label "Requirement for minimum number of exits per compartment, floor, or room"@en ;
    rdfs:comment "Based on Article 2.2.1.1: Minimum exit requirements based on maximum occupancy thresholds."@en ;
    sh:targetClass fro:Compartment, fbo:BuildingStorey, fbo:Room ;
    sh:property [
        sh:path fro:hasMaximumOccupancy ;
        sh:datatype xsd:integer ;
        sh:minCount 1 ;
        sh:message "Elk compartiment, bouwlaag of lokaal moet een gedefinieerde maximale bezetting hebben."@nl ;
    ] ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Het aantal uitgangen voor {?this} ({?exitCount}) voldoet niet aan het wettelijk minimum ({?minExits}) voor een bezetting van {?maxOccupancy} personen."@nl ;
        sh:select """
            PREFIX fro: <https://ontology.firebim.be/ontology/fro#>
            SELECT $this ?maxOccupancy ?exitCount ?minExits
            WHERE {
                $this fro:hasMaximumOccupancy ?maxOccupancy .
                
                # Count actual exits associated with the subject
                {
                    SELECT $this (COUNT(?exit) AS ?count)
                    WHERE {
                        $this fro:hasExit ?exit .
                    }
                    GROUP BY $this
                }
                BIND(?count AS ?exitCount)

                # Logic for minimum required exits (minExits)
                # 1. < 100 => 1
                # 2. 100 <= x < 500 => 2
                # 3. >= 500 => 2 + n (where n is integer immediately larger than occupancy/1000)
                # n = FLOOR(occupancy / 1000) + 1
                BIND(
                    IF(?maxOccupancy < 100, 1,
                        IF(?maxOccupancy < 500, 2,
                            2 + (FLOOR(?maxOccupancy / 1000) + 1)
                        )
                    ) AS ?minExits
                )
                
                # Check if requirement is violated
                FILTER (?exitCount < ?minExits)
            }
        """ ;
    ] ;
    sh:severity sh:Violation .