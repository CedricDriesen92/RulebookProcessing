@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix fro: <http://www.firebim.org/ontologies/fro#> .
@prefix fbo: <http://www.firebim.org/ontologies/fbo#> .

<https://ontology.firebim.be/ontology/fro#Article_2_2_2_1>
    a sh:NodeShape ;
    rdfs:label "Article 2.2.2.1: Uitgangen en Evacuatiewegen"@nl ;
    rdfs:comment "Regulates exits, evacuation routes, and specific requirements for underground levels and evacuation levels."@en ;
    sh:targetClass fro:FireCompartment ;
    
    # 1. Exits must be in opposite zones
    # "De uitgangen zijn gelegen in tegenovergestelde zones van het compartiment."
    sh:property [
        sh:path fro:hasExitZoneDistribution ;
        sh:hasValue fro:OppositeZones ;
        sh:message "De uitgangen moeten gelegen zijn in tegenovergestelde zones van het compartiment."@nl ;
        sh:severity sh:Violation ;
    ] ;

    # 2. Evacuation routes destinations
    # "De evacuatiewegen leiden ofwel: naar buiten; naar trappenhuizen; naar trappen..."
    sh:property [
        sh:path ( fro:hasEvacuationRoute fro:leadsTo ) ;
        sh:or (
            [ sh:class fro:Outdoors ]
            [ sh:class fro:Stairwell ]
            [ sh:class fro:Stairs ]
        ) ;
        sh:message "De evacuatiewegen moeten leiden naar buiten, naar trappenhuizen of naar trappen."@nl ;
        sh:severity sh:Violation ;
    ] ;

    # 3. Underground Levels Exception
    # "Wat de ondergrondse bouwlagen betreft mag één uitgang naar buiten via een evacuatieweg met wanden EI 30 en deuren EI1 30..."
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Bij ondergrondse bouwlagen moet een vervangende uitgang naar buiten wanden EI 30 en deuren EI1 30 hebben."@nl ;
        sh:prefixes [
            sh:declare [
                sh:prefix "fro" ;
                sh:namespace "http://www.firebim.org/ontologies/fro#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT $this
            WHERE {
                $this fro:isUnderground true .
                $this fro:hasEvacuationRoute ?route .
                ?route fro:leadsTo fro:Outdoors .
                ?route fro:substitutesAccessTo fro:Stairwell .
                FILTER NOT EXISTS {
                    ?route fro:hasWall [ fro:hasFireResistance "EI 30" ] .
                    ?route fro:hasDoor [ fro:hasFireResistance "EI1 30" ] .
                }
            }
        """ ;
    ] ;

    # 4. Stairs at Evacuation Level
    # "Op een evacuatieniveau leidt iedere trap naar buiten, hetzij rechtstreeks, hetzij over een evacuatieweg..."
    sh:property [
        sh:path fro:hasStair ;
        sh:node [
            a sh:NodeShape ;
            sh:property [
                sh:path fro:leadsTo ;
                sh:class fro:Outdoors ;
                sh:message "Op een evacuatieniveau moet iedere trap naar buiten leiden."@nl ;
            ]
        ] ;
        # Apply this constraint only if the compartment is on an Evacuation Level
        sh:filterShape [
            sh:path fro:locatedOnLevel ;
            sh:hasValue fro:EvacuationLevel ;
        ] ;
    ] .