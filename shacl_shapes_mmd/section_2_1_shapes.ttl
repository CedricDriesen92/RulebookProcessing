@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix fbb: <http://example.com/firebimbuilding#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix firebim: <http://example.com/firebim#> .

fbb:CompartmentShape
    a sh:NodeShape ;
    sh:targetClass fbb:Compartment ;
    fbb:flowchartNodeID "A" ;
    firebim:rulesource firebim:Section_2_1 ;
    sh:property [
        sh:path fbb:IsParking ;
        sh:datatype xsd:boolean ;
    ] ;
    sh:property [
        sh:path fbb:IsGroundFloor ;
        sh:datatype xsd:boolean ;
    ] ;
    sh:property [
        sh:path fbb:CompartmentArea ;
        sh:datatype xsd:decimal ;
    ] ;
    sh:rule [
        a sh:SPARQLRule ;
        sh:prefixes fbb: ;
        fbb:flowchartNodeID "B", "D", "F" ;
        sh:construct """
            CONSTRUCT {
                ?this sh:result _:b0 .
                _:b0 a sh:ValidationResult ;
                    sh:focusNode ?this ;
                    sh:resultSeverity sh:Violation ;
                    sh:resultMessage "Compartment area exceeds limits without required systems" .
            }
            WHERE {
                ?this fbb:IsParking false ;
                      fbb:IsGroundFloor false ;
                      fbb:CompartmentArea ?area .
                FILTER(?area > 2500)
                FILTER NOT EXISTS {
                    ?this fbb:HasAutomaticFireExtinguishingSystem true ;
                          fbb:HasSmokeAndHeatExhaustSystem true .
                }
            }
        """ ;
    ] .

fbb:GroundFloorCompartmentShape
    a sh:NodeShape ;
    sh:targetClass fbb:Compartment ;
    fbb:flowchartNodeID "E", "G" ;
    firebim:rulesource firebim:Section_2_1 ;
    sh:property [
        sh:path fbb:IsGroundFloor ;
        sh:hasValue true ;
    ] ;
    sh:property [
        sh:path fbb:CompartmentArea ;
        sh:maxInclusive 3500 ;
        sh:datatype xsd:decimal ;
    ] ;
    sh:property [
        sh:path fbb:CompartmentLength ;
        sh:maxInclusive 90 ;
        sh:datatype xsd:decimal ;
    ] .

fbb:MultiFloorCompartmentShape
    a sh:NodeShape ;
    sh:targetClass fbb:Compartment ;
    fbb:flowchartNodeID "O", "P", "S", "V", "X" ;
    firebim:rulesource firebim:Section_2_1 ;
    sh:or (
        [
            sh:property [
                sh:path fbb:IsDuplex ;
                sh:hasValue true ;
            ] ;
            sh:property [
                sh:path fbb:CompartmentArea ;
                sh:maxInclusive 2500 ;
                sh:datatype xsd:decimal ;
            ] ;
        ]
        [
            sh:property [
                sh:path fbb:IsTriplex ;
                sh:hasValue true ;
            ] ;
            sh:property [
                sh:path fbb:CompartmentArea ;
                sh:maxInclusive 300 ;
                sh:datatype xsd:decimal ;
            ] ;
            sh:property [
                sh:path fbb:HasAutomaticFireDetectionSystem ;
                sh:hasValue true ;
            ] ;
            sh:property [
                sh:path fbb:FireDetectionCoverage ;
                sh:hasValue "Total" ;
            ] ;
        ]
    ) .

fbb:SpecialCasesShape
    a sh:NodeShape ;
    sh:targetClass fbb:Compartment ;
    fbb:flowchartNodeID "Q", "U", "W", "Y" ;
    firebim:rulesource firebim:Section_2_1 ;
    sh:or (
        [
            sh:property [
                sh:path fbb:ContainsTechnicalRooms ;
                sh:hasValue true ;
            ]
        ]
        [
            sh:property [
                sh:path fbb:IsAtrium ;
                sh:hasValue true ;
            ] ;
            sh:property [
                sh:path fbb:HasAutomaticFireExtinguishingSystem ;
                sh:hasValue true ;
            ] ;
            sh:property [
                sh:path fbb:HasSmokeAndHeatExhaustSystem ;
                sh:hasValue true ;
            ]
        ]
    ) .